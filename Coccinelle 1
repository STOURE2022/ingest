"""
Configuration Management - CORRECTION FINALE
Pour structure: .databricks/wax_ingestion_main/
"""

import os
from typing import Dict, Any


def get_local_config() -> Dict[str, Any]:
    """Configuration pour mode local - CORRECTION STRUCTURE DATABRICKS"""
    
    # ğŸ”§ CORRECTION: DÃ©tecter si on est dans .databricks/wax_ingestion_main/src/
    current_file = os.path.abspath(__file__)
    print(f"ğŸ” Fichier actuel: {current_file}")
    
    src_dir = os.path.dirname(current_file)
    print(f"ğŸ” Dossier src: {src_dir}")
    
    # Si on est dans .../wax_ingestion_main/src/, remonter d'un niveau
    if src_dir.endswith("src"):
        base = os.path.dirname(src_dir)  # .../wax_ingestion_main/
    else:
        base = src_dir
    
    print(f"ğŸ” Dossier de base: {base}")
    
    # âœ… Les fichiers sont directement dans data/input/ (pas src/data/input/)
    params = {
        "zip_path": os.path.join(base, "data", "input", "site_20251606_120015.zip"),
        "excel_path": os.path.join(base, "data", "input", "waxsite_config.xlsx"),
        "extract_dir": os.path.join(base, "data", "temp", "unzipped"),
        "log_exec_path": os.path.join(base, "data", "output", "logs_execution"),
        "log_quality_path": os.path.join(base, "data", "output", "logs_quality"),
        "env": "local",
        "version": "v1"
    }
    
    # CrÃ©er les dossiers nÃ©cessaires
    for key in ["extract_dir", "log_exec_path", "log_quality_path"]:
        try:
            os.makedirs(params[key], exist_ok=True)
            print(f"âœ… Dossier crÃ©Ã©/vÃ©rifiÃ©: {params[key]}")
        except Exception as e:
            print(f"âš ï¸  Erreur crÃ©ation dossier {key}: {e}")
    
    # VÃ©rification des fichiers
    print("\nğŸ“‚ VÃ©rification des fichiers:")
    for key in ["zip_path", "excel_path"]:
        path = params[key]
        if os.path.exists(path):
            size = os.path.getsize(path)
            print(f"  âœ… {key}: {path} ({size:,} bytes)")
        else:
            print(f"  âŒ {key}: {path} - FICHIER MANQUANT!")
            # Chercher le fichier dans d'autres emplacements
            filename = os.path.basename(path)
            search_dirs = [
                base,
                os.path.join(base, "data"),
                os.path.join(base, "data", "input"),
                os.path.join(base, "src", "data", "input"),
            ]
            print(f"     ğŸ” Recherche de {filename}...")
            for search_dir in search_dirs:
                test_path = os.path.join(search_dir, filename)
                if os.path.exists(test_path):
                    print(f"     âœ… TROUVÃ‰: {test_path}")
                    # Mettre Ã  jour le chemin
                    params[key] = test_path
                    break
    
    return params


def get_databricks_config(dbutils) -> Dict[str, Any]:
    """Configuration pour Databricks Cloud"""
    dbutils.widgets.text("zip_path", "dbfs:/FileStore/tables/site_20251606_120015.zip", "ğŸ“¦ ZIP")
    dbutils.widgets.text("excel_path", "dbfs:/FileStore/tables/waxsite_config.xlsx", "ğŸ“‘ Excel")
    dbutils.widgets.text("extract_dir", "dbfs:/tmp/unzipped", "ğŸ“‚ Extract")
    dbutils.widgets.text("log_exec_path", "/mnt/logs/wax_execution_logs_delta", "ğŸ“ Logs Exec")
    dbutils.widgets.text("log_quality_path", "/mnt/logs/wax_data_quality_errors_delta", "ğŸš¦ Logs Quality")
    dbutils.widgets.text("env", "dev", "ğŸŒ Env")
    dbutils.widgets.text("version", "v1", "ğŸ“– Version")
    
    return {k: dbutils.widgets.get(k) for k in [
        "zip_path", "excel_path", "extract_dir", 
        "log_exec_path", "log_quality_path", "env", "version"
    ]}


def is_databricks() -> bool:
    """DÃ©tecte si on est sur Databricks Cloud"""
    return 'DATABRICKS_RUNTIME_VERSION' in os.environ


def get_config(dbutils=None) -> Dict[str, Any]:
    """Auto-dÃ©tection de l'environnement"""
    if dbutils is not None or is_databricks():
        print("ğŸŒ Mode DATABRICKS CLOUD")
        return get_databricks_config(dbutils)
    else:
        print("ğŸ’» Mode LOCAL (Databricks Connect)")
        return get_local_config()


def print_config(params: Dict[str, Any]):
    """Affiche la configuration"""
    print("\n" + "="*80)
    print("ğŸ“¥ CONFIGURATION CHARGÃ‰E")
    print("="*80)
    for k, v in params.items():
        exists = ""
        if k in ["zip_path", "excel_path"]:
            exists = " âœ…" if os.path.exists(v) else " âŒ MANQUANT"
        print(f"  {k:20s}: {v}{exists}")
    print("="*80 + "\n")
